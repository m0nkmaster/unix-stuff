#!/bin/sh 
#
# Reithproxies script = sets up my mac for working ON or OFF Reith

# Prepare the ground work
networkLocation=$(networksetup -getcurrentlocation)
stateFile=".onoffreith"
secureFile="/Volumes/SecureDrive/ca.pem"
touch ~/"$stateFile"
currentState=`less ~/$stateFile`
changeProxies=false

# Is SecureDrive mounted?
if [ ! -e "$secureFile" ]
then
    hdiutil attach ~/SecureDrive.dmg
fi

# ON NETWORK SETTINGS - Always run
if [[ "$networkLocation" = "BBC On Network" ]]
then
    .reithproxies
fi

# OFF NETWORK SETTINGS - Always run
if [[ "$networkLocation" = "BBC Off Network" ]]
then
    .removeproxies
fi


# ON NETWORK SETTINGS - Only run if not already set
if [[ "$networkLocation" = "BBC On Network" && "$currentState" != "on" ]]
then
    msg="BBC On Network"
    `echo "on" > ~/$stateFile`
    changeProxies=true
    localeName=work
    volume=1
fi

# OFF NETWORK SETTINGS - Only run if not already set
if [[ "$networkLocation" = "BBC Off Network" && "$currentState" != "off" ]]
then
    msg="BBC Off Network"
    `echo "off" > ~/$stateFile`
    changeProxies=true
    localeName=home
    volume=3
fi

if [ $changeProxies = true ]
then 
    # Stop stunnel
    killall stunnel

    # Set volume
    osascript -e "set Volume $volume"

    echo "Changing SVN settings"
    ln -sf /Volumes/SecureDrive/subversion/servers.$localeName /Volumes/SecureDrive/subversion/servers

    echo "Changing Stunnel settings"
    ln -sf /Volumes/SecureDrive/stunnel/stunnel-$localeName.conf /Volumes/SecureDrive/stunnel/stunnel.conf
    stunnel

    terminal-notifier -message $msg -title "Reith Setup"
fi
